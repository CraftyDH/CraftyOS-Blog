<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Interrupts - Timers and Keyboard | CraftyOS Blog</title>
<meta name=keywords content>
<meta name=description content="Interrupts Interrupts are essential to a computer functioning, they allow your keyboard and mouse to interrupt the CPU and tell it that an event is waiting. This means that when a program is running the kernel gets control of the CPU so that it can process the keyboard event. This also enables the CPU to tell us when we do something stupid such as dividing 0 by 0.
Timeline In this week the interrupts and exceptions were quite easy to write with Phillop&rsquo;s tutorials help.">
<meta name=author content="CraftyDH">
<link rel=canonical href=https://craftydh.github.io/CraftyOS-Blog/posts/interrupts/>
<link crossorigin=anonymous href=/CraftyOS-Blog/assets/css/stylesheet.min.6cba0d81b5f3f42bb578d49f402ba4175aa72b43def148780b8ad714c957c6f5.css integrity="sha256-bLoNgbXz9Cu1eNSfQCukF1qnK0Pe8Uh4C4rXFMlXxvU=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/CraftyOS-Blog/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://craftydh.github.io/CraftyOS-Blog/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://craftydh.github.io/CraftyOS-Blog/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://craftydh.github.io/CraftyOS-Blog/favicon-32x32.png>
<link rel=apple-touch-icon href=https://craftydh.github.io/CraftyOS-Blog/apple-touch-icon.png>
<link rel=mask-icon href=https://craftydh.github.io/CraftyOS-Blog/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.1">
<meta property="og:title" content="Interrupts - Timers and Keyboard">
<meta property="og:description" content="Interrupts Interrupts are essential to a computer functioning, they allow your keyboard and mouse to interrupt the CPU and tell it that an event is waiting. This means that when a program is running the kernel gets control of the CPU so that it can process the keyboard event. This also enables the CPU to tell us when we do something stupid such as dividing 0 by 0.
Timeline In this week the interrupts and exceptions were quite easy to write with Phillop&rsquo;s tutorials help.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://craftydh.github.io/CraftyOS-Blog/posts/interrupts/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-08-29T00:00:00+00:00">
<meta property="article:modified_time" content="2021-08-29T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Interrupts - Timers and Keyboard">
<meta name=twitter:description content="Interrupts Interrupts are essential to a computer functioning, they allow your keyboard and mouse to interrupt the CPU and tell it that an event is waiting. This means that when a program is running the kernel gets control of the CPU so that it can process the keyboard event. This also enables the CPU to tell us when we do something stupid such as dividing 0 by 0.
Timeline In this week the interrupts and exceptions were quite easy to write with Phillop&rsquo;s tutorials help.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://craftydh.github.io/CraftyOS-Blog/posts/"},{"@type":"ListItem","position":2,"name":"Interrupts - Timers and Keyboard","item":"https://craftydh.github.io/CraftyOS-Blog/posts/interrupts/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Interrupts - Timers and Keyboard","name":"Interrupts - Timers and Keyboard","description":"Interrupts Interrupts are essential to a computer functioning, they allow your keyboard and mouse to interrupt the CPU and tell it that an event is waiting. This means that when a program is running the kernel gets control of the CPU so that it can process the keyboard event. This also enables the CPU to tell us when we do something stupid such as dividing 0 by 0.\nTimeline In this week the interrupts and exceptions were quite easy to write with Phillop\u0026rsquo;s tutorials help.","keywords":[],"articleBody":"Interrupts Interrupts are essential to a computer functioning, they allow your keyboard and mouse to interrupt the CPU and tell it that an event is waiting. This means that when a program is running the kernel gets control of the CPU so that it can process the keyboard event. This also enables the CPU to tell us when we do something stupid such as dividing 0 by 0.\nTimeline In this week the interrupts and exceptions were quite easy to write with Phillop’s tutorials help. As a result I also didn’t have any notable challenges. The project is on track with the Timeline and I will begin work on paging and memory next week.\nExceptions To handle exceptions we must first program the IDT and GDT, checkout Phillip’s tutorial for more on those. Then we can program handler function for the exceptions. To create a external function for the interrupts I used rust’s FFI for x86-interrupt. This image below shows a double fault because we don’t have a break-point handler.\nTo fix this we create a breakpoint handler which will show us where the code had a breakpoint, as well as where the stack is. This would allow us in the future to be able to change the stack and monkey patch code, for debugging purposes. An example breakpoint stack frame is shown below.\nTimer As the timer always goes and we currently have nothing to time, the OS just prints a “.” to the screen. In the near future, this could be used for multitasking in-order to switch tasks. I could also make a program that acts as a timer or a stopwatch. As shown in the gif below the timer outputs quite a few interrupts per second.\nKeyboard For a PS2 keyboard an interrupt is fired every time a key is pressed. Thankfully for us QEMU emulates a PS2 keyboard using your hosts keyboard interface. However do the the complexities of their being over 3 different common scan-code sets, I opted to use a library to process the keyboard interrupts and return the ASCII character. As shown below the keyboard interrupts appear asynchronously along with the timer.\n","wordCount":"359","inLanguage":"en","datePublished":"2021-08-29T00:00:00Z","dateModified":"2021-08-29T00:00:00Z","author":{"@type":"Person","name":"CraftyDH"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://craftydh.github.io/CraftyOS-Blog/posts/interrupts/"},"publisher":{"@type":"Organization","name":"CraftyOS Blog","logo":{"@type":"ImageObject","url":"https://craftydh.github.io/CraftyOS-Blog/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://craftydh.github.io/CraftyOS-Blog/ accesskey=h title="CraftyOS Blog (Alt + H)">CraftyOS Blog</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://craftydh.github.io/CraftyOS-Blog/archives title=Archive>
<span>Archive</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Interrupts - Timers and Keyboard
</h1>
<div class=post-meta>August 29, 2021&nbsp;·&nbsp;CraftyDH
</div>
</header>
<div class=post-content><h2 id=interrupts>Interrupts<a hidden class=anchor aria-hidden=true href=#interrupts>#</a></h2>
<p>Interrupts are essential to a computer functioning, they allow your keyboard and mouse to interrupt the CPU and tell it that an event is waiting. This means that when a program is running the kernel gets control of the CPU so that it can process the keyboard event. This also enables the CPU to tell us when we do something stupid such as dividing 0 by 0.</p>
<h3 id=timeline>Timeline<a hidden class=anchor aria-hidden=true href=#timeline>#</a></h3>
<p>In this week the interrupts and exceptions were quite easy to write with Phillop&rsquo;s tutorials help. As a result I also didn&rsquo;t have any notable challenges. The project is on track with the <a href=https://craftydh.github.io/CraftyOS-Blog/posts/restart/#revised-timeline>Timeline</a> and I will begin work on paging and memory next week.</p>
<h2 id=exceptions>Exceptions<a hidden class=anchor aria-hidden=true href=#exceptions>#</a></h2>
<p>To handle exceptions we must first program the IDT and GDT, checkout Phillip&rsquo;s tutorial for more on those. Then we can program handler function for the exceptions. To create a external function for the interrupts I used rust&rsquo;s FFI for <code>x86-interrupt</code>. This image below shows a double fault because we don&rsquo;t have a break-point handler.</p>
<p><img loading=lazy src=no_breakpoint.png alt="No breakpoint handler screenshot" title="No breakpoint handler screenshot">
</p>
<p>To fix this we create a breakpoint handler which will show us where the code had a breakpoint, as well as where the stack is. This would allow us in the future to be able to change the stack and monkey patch code, for debugging purposes. An example breakpoint stack frame is shown below.</p>
<p><img loading=lazy src=breakpoint.png alt="Breakpoint handler screenshot" title="Breakpoint handler screenshot">
</p>
<h2 id=timer>Timer<a hidden class=anchor aria-hidden=true href=#timer>#</a></h2>
<p>As the timer always goes and we currently have nothing to time, the OS just prints a &ldquo;.&rdquo; to the screen. In the near future, this could be used for multitasking in-order to switch tasks. I could also make a program that acts as a timer or a stopwatch. As shown in the gif below the timer outputs quite a few interrupts per second.</p>
<p><img loading=lazy src=timer.gif alt="Timer example" title="Timer dots">
</p>
<h2 id=keyboard>Keyboard<a hidden class=anchor aria-hidden=true href=#keyboard>#</a></h2>
<p>For a PS2 keyboard an interrupt is fired every time a key is pressed. Thankfully for us QEMU emulates a PS2 keyboard using your hosts keyboard interface. However do the the complexities of their being over 3 different common scan-code sets, I opted to use a library to process the keyboard interrupts and return the ASCII character. As shown below the keyboard interrupts appear asynchronously along with the timer.</p>
<p><img loading=lazy src=keyboard.gif alt="Keyboard example" title="Keyboard and timer dots">
</p>
</div>
<footer class=post-footer>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://craftydh.github.io/CraftyOS-Blog/>CraftyOS Blog</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)">
<button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</button>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>